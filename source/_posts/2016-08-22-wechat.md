---
title: 使用Node开发微信总结
categories: node
tags: [node]
---

这几天在练习用node开发微信公众号和微信内嵌网页，基本上把主要的功能都过了一遍，也动手敲了几个demo，整套练习做完之后，有很多体会，下面总结一下心得。

## 域名

微信开发需要域名，映射到本地的ip和端口，一开始借助ngrok，缺点就是不太稳定，经常会挂掉。后来就换成QQ浏览器提供的微信开发工具来生成临时域名。

## 认证

微信接口认证也就是获取access_token，将token、timestamp、nonce三个参数进行字典排序，然后再进行sha1加密，最后与signatrue对比。这个过程需要非常细心，当时花了很长时间调试。

另外，获取access_token是有次数限制的，每天2000次，所以要在服务端缓存，可以保存到数据库或者本地文件。

## Koa

服务端使用Koa框架来开发，Koa最核心的功能就是中间件，每个中间件传入use函数，就能按顺序执行。使用yield语法就可以实现类似“断点”式的开发。使用Koa，再加上Promise，可以写出来很优雅的代码。

## 自动回复功能

客户端、微信服务器和node服务器的通信流程：

1. 客户端触发事件，微信服务器推送事件到node服务器；
2. 微信服务器推送的事件是使用POST方法，格式为XML；
3. node服务器返回XML格式的数据给微信服务器，最终再客户端完成响应。

使用ejs模板需要对各种消息的模块（文字消息，图文消息，音频视频消息等等）进行封装。

## 微信开发工具

- 可以调试JS-SDK；
- 有chrome控制台，非常好用；
- 用移动调试，很酷。

